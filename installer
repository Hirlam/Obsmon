#!/usr/bin/env Rscript
# Source needed files
argv <- commandArgs(trailingOnly = FALSE)
thisFilePath <- normalizePath(sub("--file=", "", argv[grep("--file=", argv)]))
sourcesDir <- file.path(dirname(thisFilePath), "src")
sourceFiles <- file.path(sourcesDir, c(
  "argparse_wrappers.R",
  "import_finder.R",
  "dependencies.R",
  "install.R",
  "get_sys_info.R"
))
for(sourceFile in sourceFiles) source(sourceFile)

# Get dependencies
availablePkgsDb <- available.packages()
pkgDepsDf <- getImportedPkgsDepsDf(
  path=args$path,
  ignore_regex=args$ignore,
  availablePkgsDb=availablePkgsDb
)
depsSummaryDf <- summarisePkgDepsDf(
  pkgDepsDf,
  availablePkgsDb=availablePkgsDb
)

# Show dependency list
printDepsFromDf(depsSummaryDf)
if(args$listdeps) quit(status=0)

# Install
installPkgsFromDf(
  df=depsSummaryDf,
  lib=args$install_path,
  repos=args$repos,
  binDirs=args$bin_repo_path,
  binSaveDir=args$bin_save_path
)
