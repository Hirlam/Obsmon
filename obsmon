#!/usr/bin/env Rscript
args <- commandArgs(trailingOnly = FALSE)

libLoc=Sys.getenv("R_LIBS_USER")
if(libLoc=="") libLoc=file.path(Sys.getenv("HOME"), "R", "library")
libLoc <- path.expand(libLoc)
Sys.setenv(R_LIBS_USER=libLoc)

# Changing work dir to obsmonSrcDir, so all needed files can be found
thisFilePath <- normalizePath(sub("--file=", "", args[grep("--file=", args)]))
# Accounting for the fact that the script may be executed via a symlink
obsmonSrcDir <- dirname(Sys.readlink(thisFilePath))
if(obsmonSrcDir=="" || is.na(obsmonSrcDir)) obsmonSrcDir<-dirname(thisFilePath)
setwd(obsmonSrcDir)

# Initialising
source("init.R")

shinydir <- obsmonSrcDir

runAppHandlingBusyPort <- function(
  callAndErrorMsg=NULL, defaultPort=5391, recDepth=0, maxNAtt=10
) {
  if(recDepth==0) {
    tryCatch(
      runApp(shinydir, launch.browser=FALSE, port=defaultPort),
      error=function(w) runAppHandlingBusyPort(w, recDepth=recDepth+1)
    )
  } else if (recDepth+1>maxNAtt) {
    msg <- paste("Failed to create server after",maxNAtt,"attempts.",sep=" ")
    msg <- paste(msg, "\n", "Stopping now.\n", sep=" ")
    stop(msg)
  } else {
      msg <- callAndErrorMsg[["message"]]
      cat(msg, "\n")
      cat("Trying again with a different TCP port:\n")
      tryCatch(
        runApp(shinydir, launch.browser=FALSE),
        error=function(w) runAppHandlingBusyPort(w, recDepth=recDepth+1)
      )
  }
}

runAppHandlingBusyPort(defaultPort=5391)
